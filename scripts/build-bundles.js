#!/usr/bin/env node
/**
 * Lightweight bundler (concatenation) to produce two-script setup per platform:
 *  - dist/content-lib.js  ← common/shared code
 *  - dist/{platform}-adapter.js ← platform-specific config + content script
 *
 * Keeps ordering stable without full bundler tooling.
 */
const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const distDir = path.join(root, 'dist');

const COMMON_FILES = [
  'content-scripts/bootstrap-flags.js',
  'selector-manager-strategies.js',
  'selector-manager.js',
  'selectors-config.js',
  'utils/humanoid-lifecycle.js',
  'utils/cleanup-registry.js',
  'humanoid.js',
  'scroll-toolkit.js',
  'content-scripts/pipeline-config.js',
  'content-scripts/platform-selectors.js',
  'content-scripts/pipeline-modules.js',
  'content-scripts/unified-answer-watcher.js',
  'content-scripts/sanity-check.js',
  'content-scripts/unified-answer-pipeline.js',
  'content-scripts/fetch-monitor.js'
];

const PLATFORM_MAP = {
  chatgpt: ['selectors/chatgpt.config.js', 'content-scripts/content-chatgpt.js'],
  perplexity: ['selectors/perplexity.config.js', 'content-scripts/content-perplexity.js'],
  gemini: ['selectors/gemini.config.js', 'content-scripts/content-gemini.js'],
  claude: ['selectors/claude.config.js', 'content-scripts/content-claude.js'],
  grok: ['selectors/grok.config.js', 'content-scripts/content-grok.js'],
  qwen: ['selectors/qwen.config.js', 'content-scripts/content-qwen.js'],
  lechat: ['selectors/lechat.config.js', 'content-scripts/content-lechat.js'],
  deepseek: ['selectors/deepseek.config.js', 'content-scripts/content-deepseek.js']
};

function readFileSafe(relPath) {
  const filePath = path.join(root, relPath);
  if (!fs.existsSync(filePath)) {
    console.warn(`[build] WARN: missing ${relPath}, skipping`);
    return '';
  }
  return fs.readFileSync(filePath, 'utf8');
}

function writeBundle(outFile, parts) {
  const banner = `// Auto-generated by scripts/build-bundles.js @ ${new Date().toISOString()}\n`;
  const content = banner + parts.join('\n;\n');
  fs.writeFileSync(outFile, content, 'utf8');
  console.log(`[build] wrote ${path.relative(root, outFile)}`);
}

function buildCommon() {
  const parts = COMMON_FILES.map(readFileSafe);
  const outFile = path.join(distDir, 'content-lib.js');
  writeBundle(outFile, parts);
}

function buildPlatformAdapters() {
  Object.entries(PLATFORM_MAP).forEach(([platform, files]) => {
    const parts = files.map(readFileSafe);
    const outFile = path.join(distDir, `${platform}-adapter.js`);
    writeBundle(outFile, parts);
  });
}

function ensureDist() {
  if (!fs.existsSync(distDir)) {
    fs.mkdirSync(distDir, { recursive: true });
  }
}

function main() {
  ensureDist();
  buildCommon();
  buildPlatformAdapters();
  console.log('[build] done');
}

if (require.main === module) {
  main();
}
