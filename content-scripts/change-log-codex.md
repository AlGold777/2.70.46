# Журнал изменений: `content-claude.js`

**Дата:** 2025-12-13
**Цель сессии:** Устранить проблемы с вставкой и отправкой запросов на сайте `claude.ai`.

---

### Изменение 1: Устранение удаления запроса после вставки

*   **Проблема:** Запрос, вставленный в поле ввода, немедленно удалялся, что делало невозможным отправку.
*   **Анализ:** Проблема была вызвана конфликтом между скриптом и современным редактором Claude (ProseMirror). Программная очистка поля перед вставкой текста приводила к сбросу состояния редактора.
*   **Решение:**
    *   Из функции `typeWithHumanPauses` был удален вызов `resetComposer()`, который производил избыточную очистку.
    *   Оптимизирована стратегия ввода: приоритет отдан более надежным нативным методам (`setContentEditableText` и `setNativeValue`).

---

### Изменение 2: Обеспечение отправки запроса

*   **Проблема:** После исправления вставки запрос оставался в поле ввода, но не отправлялся.
*   **Анализ:** Кнопка отправки могла быть неактивна в момент клика, или сам клик не регистрировался интерфейсом.
*   **Решение:**
    *   Внедрен цикл "умного ожидания", который проверяет, стала ли кнопка отправки кликабельной, вместо фиксированной паузы.
    *   Добавлен более надежный метод клика (`humanoid.click`) и запасной вариант с имитацией нажатия клавиши `Enter`.
    *   Улучшена функция `confirmClaudeSend` для более точного подтверждения отправки.

---

### Изменение 3: Исправление добавления пустых строк

*   **Проблема:** При вставке текста в поле ввода добавлялись лишние пустые строки.
*   **Анализ:** Редактор ProseMirror мог содержать невидимые теги `<p><br></p>`, которые приводили к некорректной вставке.
*   **Решение:**
    *   Реализована новая, более аккуратная функция `resetComposer`, которая полностью очищает поле ввода и создает "чистый лист" перед вставкой.
    *   В качестве основного метода отправки внедрен `form.requestSubmit()`, который является более надежным, чем симуляция клика.

---

### Изменение 4: Комплексное исправление стабильности

*   **Проблема:** В консоли появлялась ошибка `SecurityError` из `humanoid.js`, которая прерывала выполнение всего скрипта. Повторные попытки отправки не работали из-за кэширования неудачного промиса.
*   **Анализ:** Ошибка возникала при попытке `humanoid.js` взаимодействовать с `iframe`, к которому нет доступа. Это исключение не обрабатывалось должным образом и "ломало" всю цепочку действий.
*   **Решение:**
    *   Вызов `humanoid.typeText` обернут в блок `try...catch`, чтобы ошибка в нем не останавливала выполнение, а позволяла перейти к запасному методу.
    *   Исправлена логика кэширования операции (`claudeSharedInjection`), чтобы при ошибке кэш очищался и следующая попытка начиналась заново.

---

### Изменение 5: Оптимизация задержки перед отправкой

*   **Проблема:** После всех исправлений задержка между вставкой текста и отправкой была излишне большой (8 секунд).
*   **Решение:**
    *   Максимальное время ожидания активации кнопки отправки в `content-claude.js` было уменьшено с `8000` до `5000` миллисекунд.

---

## Итог

В результате всех изменений была полностью восстановлена функциональность вставки и отправки запросов на сайте `claude.ai`. Процесс стал более быстрым, стабильным и устойчивым к ошибкам и особенностям интерфейса.