<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Panel Prototype v10</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e4e4e7;
        }
        
        .pipeline-panel {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title { font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; }
        .pipeline-name { font-size: 15px; font-weight: 700; color: #fff; margin-top: 2px; }
        .header-actions { display: flex; gap: 8px; }
        
        .btn {
            padding: 7px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: #e4e4e7;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.1); }
        .btn-primary { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-clear { border-color: rgba(239, 68, 68, 0.3); color: #f87171; }
        .btn-clear:hover { background: rgba(239, 68, 68, 0.1); }
        
        .pipeline-canvas {
            padding: 24px 20px;
            overflow-x: auto;
            position: relative;
            min-height: 340px;
        }
        
        .pipeline-flow {
            display: flex;
            align-items: flex-start;
            min-width: max-content;
        }
        
        .stage-column { display: flex; flex-direction: column; align-items: center; }
        
        .stage-label {
            font-size: 10px;
            font-weight: 600;
            color: #71717a;
            text-transform: uppercase;
            margin-bottom: 10px;
            height: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .round-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
        }
        
        .entry-point {
            width: 18px; height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid #1e3a5f;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px;
            transition: margin-top 0.3s ease;
        }
        
        .model-stack, .collector-stack, .output-stack { display: flex; flex-direction: column; }
        
        .model-block {
            width: 110px; height: 52px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border: 2px solid #3f3f46;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            display: flex; flex-direction: column; justify-content: center;
            margin-bottom: 6px;
        }
        .model-block:last-child { margin-bottom: 0; }
        .model-block.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .model-block.inactive { border-color: #27272a; background: rgba(0,0,0,0.2); opacity: 0.5; }
        
        .model-header { display: flex; align-items: center; gap: 6px; }
        .model-checkbox { width: 13px; height: 13px; accent-color: #3b82f6; cursor: pointer; }
        .model-name { font-size: 11px; font-weight: 600; color: #e4e4e7; }
        
        .role-selector {
            width: 100%;
            padding: 3px 4px;
            font-size: 9px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #e4e4e7;
            cursor: pointer;
            margin-top: 4px;
        }
        .role-selector:disabled { opacity: 0.3; }
        
        .connector-group { display: flex; align-items: flex-start; padding-top: 26px; }
        .connector-svg { width: 50px; height: 240px; overflow: visible; }
        
        .connector-line { stroke: #52525b; stroke-width: 2; fill: none; }
        .connector-line.active { stroke: #60a5fa; }
        .connector-line.brain-flow { stroke: #fb923c; }
        
        .merge-line { stroke: #52525b; stroke-width: 2; }
        .merge-line.active { stroke: #60a5fa; }
        .merge-line.brain-flow { stroke: #fb923c; }
        
        .arrow-head { fill: #52525b; }
        .arrow-head.active { fill: #60a5fa; }
        .arrow-head.brain-flow { fill: #fb923c; }
        
        .flow-anim { stroke-dasharray: 6 4; animation: flowAnim 0.6s linear infinite; }
        @keyframes flowAnim { to { stroke-dashoffset: -10; } }
        
        /* Responses - purple */
        .collector-row {
            width: 100px; height: 52px;
            margin-bottom: 6px;
            padding: 0 10px;
            background: rgba(139, 92, 246, 0.08);
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.3s;
        }
        .collector-row:last-child { margin-bottom: 0; }
        .collector-row.inactive { border-color: #27272a; background: rgba(0,0,0,0.2); opacity: 0.5; }
        
        /* Results - green */
        .results-column .collector-row {
            background: rgba(34, 197, 94, 0.08);
            border-color: #22c55e;
        }
        .results-column .collector-row.inactive {
            border-color: #27272a;
            background: rgba(0,0,0,0.2);
        }
        .results-column .collector-model-name { color: #86efac; }
        .results-column .collector-checkbox { accent-color: #22c55e; }
        
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: #52525b; flex-shrink: 0; }
        .collector-model-name { font-size: 10px; color: #c4b5fd; flex: 1; font-weight: 500; }
        .collector-checkbox { width: 14px; height: 14px; accent-color: #8b5cf6; cursor: pointer; }
        .collector-checkbox:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .output-block {
            width: 100px; height: 52px;
            margin-bottom: 6px;
            padding: 8px 10px;
            background: rgba(34, 197, 94, 0.08);
            border: 2px solid #22c55e;
            border-radius: 8px;
            cursor: pointer;
            display: flex; flex-direction: column; justify-content: center;
        }
        .output-block:last-child { margin-bottom: 0; }
        .output-block.inactive { border-color: #27272a; background: rgba(0,0,0,0.2); opacity: 0.5; }
        
        .output-header { display: flex; align-items: center; gap: 6px; }
        .output-checkbox { width: 13px; height: 13px; accent-color: #22c55e; }
        .output-icon { font-size: 12px; }
        .output-name { font-size: 11px; font-weight: 600; color: #4ade80; }
        .output-block.inactive .output-name { color: #71717a; }
        .output-desc { font-size: 8px; color: #71717a; margin-top: 2px; margin-left: 19px; }
        
        .round-buttons {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
        }
        
        .add-round-btn, .remove-round-btn {
            width: 36px; height: 36px;
            border-radius: 10px;
            border: 2px dashed #3f3f46;
            background: rgba(0,0,0,0.3);
            color: #71717a;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .add-round-btn:hover { border-color: #3b82f6; border-style: solid; color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .remove-round-btn { display: none; }
        .remove-round-btn:hover { border-color: #ef4444; border-style: solid; color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        .pipeline-list { border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 20px; }
        
        .pipeline-list-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .pipeline-list-header h3 { font-size: 10px; font-weight: 600; color: #71717a; }
        
        .add-pipeline-btn {
            width: 18px; height: 18px;
            border-radius: 4px;
            border: 1px dashed #3f3f46;
            background: transparent;
            color: #71717a;
            font-size: 12px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .add-pipeline-btn:hover {
            border-color: #3b82f6;
            border-style: solid;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .pipeline-items { display: flex; flex-direction: column; gap: 4px; }
        .pipeline-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; cursor: pointer; }
        .pipeline-item:hover .pipeline-item-name { color: #e4e4e7; }
        .pipeline-radio { width: 14px; height: 14px; accent-color: #3b82f6; cursor: pointer; }
        .pipeline-item-name { font-size: 11px; color: #a1a1aa; transition: color 0.2s; }
        .pipeline-item.active .pipeline-item-name { color: #60a5fa; font-weight: 600; }
        .last-badge { font-size: 8px; color: #3b82f6; background: rgba(59, 130, 246, 0.15); padding: 2px 5px; border-radius: 3px; margin-left: 4px; }
    </style>
</head>
<body>
    <div class="pipeline-panel">
        <div class="panel-header">
            <div>
                <div class="panel-title">Pipeline</div>
                <div class="pipeline-name" id="currentPipelineName">Research & Analysis</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-icon btn-clear" onclick="resetPipeline()">üóëÔ∏è</button>
                <button class="btn" onclick="savePipeline()">üíæ</button>
                <button class="btn btn-primary">‚ñ∂ Run</button>
            </div>
        </div>
        
        <div class="pipeline-canvas">
            <div class="pipeline-flow" id="pipelineFlow">
                
                <!-- Entry -->
                <div class="stage-column">
                    <div class="stage-label">In</div>
                    <div class="entry-wrapper" id="entryWrapper" style="height: 240px; display: flex; align-items: flex-start;">
                        <div class="entry-point" id="entryPoint">‚ñ∂</div>
                    </div>
                </div>
                
                <!-- Connector In -> Models (split) -->
                <div class="connector-group">
                    <svg class="connector-svg" id="svg-in-models"></svg>
                </div>
                
                <!-- R1 Models -->
                <div class="stage-column" id="round1">
                    <div class="stage-label"><span class="round-badge">R1</span> Models</div>
                    <div class="model-stack" id="r1-models">
                        <div class="model-block active" data-index="0">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                <span class="model-name">Claude</span>
                            </div>
                        </div>
                        <div class="model-block active" data-index="1">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                <span class="model-name">GPT-4</span>
                            </div>
                        </div>
                        <div class="model-block active" data-index="2">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                <span class="model-name">Gemini</span>
                            </div>
                        </div>
                        <div class="model-block inactive" data-index="3">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                <span class="model-name">Llama 3</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Connector R1 -> Responses -->
                <div class="connector-group">
                    <svg class="connector-svg" id="svg-r1-resp1"></svg>
                </div>
                
                <!-- Responses (after R1 Models) -->
                <div class="collector-column" id="responses1">
                    <div class="stage-label">Responses</div>
                    <div class="collector-stack" id="resp1-stack">
                        <div class="collector-row" data-index="0">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">Claude</span>
                            <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                        </div>
                        <div class="collector-row" data-index="1">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">GPT-4</span>
                            <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                        </div>
                        <div class="collector-row" data-index="2">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">Gemini</span>
                            <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                        </div>
                        <div class="collector-row inactive" data-index="3">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">Llama 3</span>
                            <input type="checkbox" class="collector-checkbox" disabled>
                        </div>
                    </div>
                </div>
                
                <!-- Connector Responses -> R2 Judge -->
                <div class="connector-group">
                    <svg class="connector-svg" id="svg-resp1-r2"></svg>
                </div>
                
                <!-- R2 Judge -->
                <div class="stage-column" id="round2" data-round="2">
                    <div class="stage-label"><span class="round-badge">R2</span> Judge</div>
                    <div class="model-stack" id="r2-models">
                        <div class="model-block active with-role" data-index="0">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                <span class="model-name">Claude</span>
                            </div>
                            <select class="role-selector">
                                <option>Synthesis</option>
                                <option>Critic</option>
                                <option>Meta</option>
                                <option>Advocate</option>
                            </select>
                        </div>
                        <div class="model-block active with-role" data-index="1">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                <span class="model-name">GPT-4</span>
                            </div>
                            <select class="role-selector">
                                <option>Critic</option>
                                <option>Synthesis</option>
                                <option>Meta</option>
                                <option>Advocate</option>
                            </select>
                        </div>
                        <div class="model-block inactive with-role" data-index="2">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                <span class="model-name">Gemini</span>
                            </div>
                            <select class="role-selector" disabled>
                                <option>Meta</option>
                                <option>Synthesis</option>
                                <option>Critic</option>
                                <option>Advocate</option>
                            </select>
                        </div>
                        <div class="model-block inactive with-role" data-index="3">
                            <div class="model-header">
                                <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                <span class="model-name">Llama 3</span>
                            </div>
                            <select class="role-selector" disabled>
                                <option>Advocate</option>
                                <option>Synthesis</option>
                                <option>Critic</option>
                                <option>Meta</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Insertion point for new rounds (Responses + Judge) -->
                <div id="insertionPoint"></div>
                
                <!-- Connector last Judge -> Results -->
                <div class="connector-group" id="connectorToResults">
                    <svg class="connector-svg" id="svg-judge-results"></svg>
                </div>
                
                <!-- Results (only one, directly after last Judge) -->
                <div class="collector-column results-column" id="resultsColumn">
                    <div class="stage-label">Results</div>
                    <div class="collector-stack" id="results-stack">
                        <div class="collector-row" data-index="0">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">Claude</span>
                            <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                        </div>
                        <div class="collector-row" data-index="1">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">GPT-4</span>
                            <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                        </div>
                        <div class="collector-row inactive" data-index="2">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">Gemini</span>
                            <input type="checkbox" class="collector-checkbox" disabled>
                        </div>
                        <div class="collector-row inactive" data-index="3">
                            <div class="status-indicator"></div>
                            <span class="collector-model-name">Llama 3</span>
                            <input type="checkbox" class="collector-checkbox" disabled>
                        </div>
                    </div>
                </div>
                
                <!-- Connector Results -> Output -->
                <div class="connector-group" id="connectorToOutput">
                    <svg class="connector-svg" id="svg-results-out"></svg>
                </div>
                
                <!-- Output -->
                <div class="stage-column" id="outputColumn">
                    <div class="stage-label">Output</div>
                    <div class="output-stack" id="output-stack">
                        <div class="output-block" data-index="0">
                            <div class="output-header">
                                <input type="checkbox" class="output-checkbox" checked onchange="updateAll()">
                                <span class="output-icon">üìù</span>
                                <span class="output-name">Notes</span>
                            </div>
                            <div class="output-desc">Save to DATA</div>
                        </div>
                        <div class="output-block" data-index="1">
                            <div class="output-header">
                                <input type="checkbox" class="output-checkbox" checked onchange="updateAll()">
                                <span class="output-icon">üì§</span>
                                <span class="output-name">Export</span>
                            </div>
                            <div class="output-desc">MD / JSON</div>
                        </div>
                        <div class="output-block inactive" data-index="2">
                            <div class="output-header">
                                <input type="checkbox" class="output-checkbox" onchange="updateAll()">
                                <span class="output-icon">üìã</span>
                                <span class="output-name">Clipboard</span>
                            </div>
                            <div class="output-desc">Copy</div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="round-buttons">
                <button class="add-round-btn" onclick="addRound()" title="Add Responses + Judge">+</button>
                <button class="remove-round-btn" id="removeRoundBtn" onclick="removeLastRound()" title="Remove last round">‚àí</button>
            </div>
        </div>
        
        <div class="pipeline-list">
            <div class="pipeline-list-header">
                <h3>‚ñæ Pipelines</h3>
                <button class="add-pipeline-btn" onclick="addNewPipeline()" title="New pipeline">+</button>
            </div>
            <div class="pipeline-items" id="pipelineItems">
                <div class="pipeline-item active" data-name="Research & Analysis">
                    <input type="radio" name="pipeline" class="pipeline-radio" checked>
                    <span class="pipeline-item-name">Research & Analysis</span>
                    <span class="last-badge">last</span>
                </div>
                <div class="pipeline-item" data-name="Idea Validation">
                    <input type="radio" name="pipeline" class="pipeline-radio">
                    <span class="pipeline-item-name">Idea Validation</span>
                </div>
                <div class="pipeline-item" data-name="Content Gen">
                    <input type="radio" name="pipeline" class="pipeline-radio">
                    <span class="pipeline-item-name">Content Gen</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const BLOCK_H = 58;
        const BLOCK_CENTER = 26;
        let roundCounter = 2; // Last judge round number
        
        function getBlockCenterY(index) {
            return index * BLOCK_H + BLOCK_CENTER;
        }
        
        function getCheckedIndices(stackId) {
            const stack = document.getElementById(stackId);
            if (!stack) return [];
            const indices = [];
            Array.from(stack.children).forEach((item, i) => {
                const cb = item.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) indices.push(i);
            });
            return indices;
        }
        
        function getActiveModelIndices(stackId) {
            const stack = document.getElementById(stackId);
            if (!stack) return [];
            const indices = [];
            Array.from(stack.children).forEach((item, i) => {
                const cb = item.querySelector('input[type="checkbox"]');
                if (cb && cb.checked && !cb.disabled) indices.push(i);
            });
            return indices;
        }
        
        function getOutputCheckedIndices(stackId) {
            const stack = document.getElementById(stackId);
            if (!stack) return [];
            const indices = [];
            Array.from(stack.children).forEach((item, i) => {
                const cb = item.querySelector('.output-checkbox');
                if (cb && cb.checked) indices.push(i);
            });
            return indices;
        }
        
        function drawInputSplitConnector(svgId, targetStackId, colorClass) {
            const svg = document.getElementById(svgId);
            const entryPoint = document.getElementById('entryPoint');
            if (!svg) return;
            
            const targetIndices = getActiveModelIndices(targetStackId);
            if (targetIndices.length === 0) { 
                svg.innerHTML = ''; 
                if (entryPoint) entryPoint.style.marginTop = '26px';
                return; 
            }
            
            const W = 50;
            const splitX = W - 15;
            let html = '';
            
            const targetYs = targetIndices.map(i => getBlockCenterY(i));
            const targetMinY = Math.min(...targetYs);
            const targetMaxY = Math.max(...targetYs);
            const targetMidY = (targetMinY + targetMaxY) / 2;
            
            // Position entry point at the mid Y
            if (entryPoint) {
                entryPoint.style.marginTop = (targetMidY - 9) + 'px'; // -9 for half of 18px height
            }
            
            // Main horizontal line from left
            html += `<line x1="0" y1="${targetMidY}" x2="${splitX}" y2="${targetMidY}" class="connector-line ${colorClass} flow-anim"/>`;
            
            // Vertical split line
            if (targetYs.length > 1) {
                html += `<line x1="${splitX}" y1="${targetMinY}" x2="${splitX}" y2="${targetMaxY}" class="merge-line ${colorClass}"/>`;
            }
            
            // Lines to each target with arrows
            targetYs.forEach(y => {
                html += `<line x1="${splitX}" y1="${y}" x2="${W-6}" y2="${y}" class="connector-line ${colorClass} flow-anim"/>`;
                html += `<polygon points="${W-6},${y-4} ${W},${y} ${W-6},${y+4}" class="arrow-head ${colorClass}"/>`;
            });
            
            svg.innerHTML = html;
        }
        
        function drawHorizontalConnectors(svgId, stackId, colorClass) {
            const svg = document.getElementById(svgId);
            if (!svg) return;
            
            const indices = getActiveModelIndices(stackId);
            if (indices.length === 0) { svg.innerHTML = ''; return; }
            
            const W = 50;
            let html = '';
            indices.forEach(i => {
                const y = getBlockCenterY(i);
                html += `<line x1="0" y1="${y}" x2="${W-6}" y2="${y}" class="connector-line ${colorClass} flow-anim"/>`;
                html += `<polygon points="${W-6},${y-4} ${W},${y} ${W-6},${y+4}" class="arrow-head ${colorClass}"/>`;
            });
            svg.innerHTML = html;
        }
        
        function drawMergeSplitConnector(svgId, sourceStackId, targetStackId, colorClass) {
            const svg = document.getElementById(svgId);
            if (!svg) return;
            
            // Determine which function to use for getting indices
            const isSourceCollector = /^(resp|results)/.test(sourceStackId);
            const isTargetOutput = targetStackId === 'output-stack';
            const isTargetCollector = /^(resp|results)/.test(targetStackId);
            
            const sourceIndices = isSourceCollector ? getCheckedIndices(sourceStackId) : getActiveModelIndices(sourceStackId);
            
            // For output-stack, use getCheckedIndices with output-checkbox
            let targetIndices;
            if (isTargetOutput) {
                targetIndices = getOutputCheckedIndices(targetStackId);
            } else if (isTargetCollector) {
                targetIndices = getCheckedIndices(targetStackId);
            } else {
                targetIndices = getActiveModelIndices(targetStackId);
            }
            
            if (sourceIndices.length === 0 || targetIndices.length === 0) { svg.innerHTML = ''; return; }
            
            const W = 50, mergeX = 15, splitX = W - 15;
            let html = '';
            
            const sourceYs = sourceIndices.map(i => getBlockCenterY(i));
            const targetYs = targetIndices.map(i => getBlockCenterY(i));
            
            const sourceMinY = Math.min(...sourceYs), sourceMaxY = Math.max(...sourceYs);
            const targetMinY = Math.min(...targetYs), targetMaxY = Math.max(...targetYs);
            const sourceMidY = (sourceMinY + sourceMaxY) / 2;
            const targetMidY = (targetMinY + targetMaxY) / 2;
            
            sourceYs.forEach(y => {
                html += `<line x1="0" y1="${y}" x2="${mergeX}" y2="${y}" class="connector-line ${colorClass} flow-anim"/>`;
            });
            
            if (sourceYs.length > 1) {
                html += `<line x1="${mergeX}" y1="${sourceMinY}" x2="${mergeX}" y2="${sourceMaxY}" class="merge-line ${colorClass}"/>`;
            }
            
            html += `<line x1="${mergeX}" y1="${sourceMidY}" x2="${splitX}" y2="${targetMidY}" class="connector-line ${colorClass} flow-anim"/>`;
            
            if (targetYs.length > 1) {
                html += `<line x1="${splitX}" y1="${targetMinY}" x2="${splitX}" y2="${targetMaxY}" class="merge-line ${colorClass}"/>`;
            }
            
            targetYs.forEach(y => {
                html += `<line x1="${splitX}" y1="${y}" x2="${W-6}" y2="${y}" class="connector-line ${colorClass} flow-anim"/>`;
                html += `<polygon points="${W-6},${y-4} ${W},${y} ${W-6},${y+4}" class="arrow-head ${colorClass}"/>`;
            });
            
            svg.innerHTML = html;
        }
        
        function syncCollectorWithModels(modelsStackId, collectorStackId) {
            const modelsStack = document.getElementById(modelsStackId);
            const collectorStack = document.getElementById(collectorStackId);
            
            if (!modelsStack || !collectorStack) return;
            
            const modelBlocks = modelsStack.querySelectorAll('.model-block');
            const collectorRows = collectorStack.querySelectorAll('.collector-row');
            
            modelBlocks.forEach((block, i) => {
                if (collectorRows[i]) {
                    const modelCb = block.querySelector('.model-checkbox');
                    const collectorCb = collectorRows[i].querySelector('.collector-checkbox');
                    
                    if (modelCb && collectorCb) {
                        if (modelCb.checked) {
                            collectorRows[i].classList.remove('inactive');
                            // Auto-check if was disabled (newly enabled)
                            if (collectorCb.disabled) {
                                collectorCb.checked = true;
                            }
                            collectorCb.disabled = false;
                        } else {
                            collectorRows[i].classList.add('inactive');
                            collectorCb.disabled = true;
                            collectorCb.checked = false;
                        }
                    }
                }
            });
        }
        
        function updateAll() {
            // 1. Update model blocks visual state
            document.querySelectorAll('.model-block').forEach(b => {
                const cb = b.querySelector('.model-checkbox');
                const sel = b.querySelector('.role-selector');
                if (cb.checked) {
                    b.classList.remove('inactive');
                    b.classList.add('active');
                    if (sel) sel.disabled = false;
                } else {
                    b.classList.remove('active');
                    b.classList.add('inactive');
                    if (sel) sel.disabled = true;
                }
            });
            
            // 2. Sync collectors based on current structure
            if (roundCounter === 1) {
                // Minimal template: Models -> Results
                syncCollectorWithModels('r1-models', 'results-stack');
            } else {
                // Full template with Judge(s)
                // Sync Responses R1 with R1 Models
                syncCollectorWithModels('r1-models', 'resp1-stack');
                
                // Sync intermediate Responses with their preceding Judge
                for (let r = 2; r < roundCounter; r++) {
                    syncCollectorWithModels(`r${r}-models`, `resp${r}-stack`);
                }
                
                // Sync Results with last Judge
                syncCollectorWithModels(`r${roundCounter}-models`, 'results-stack');
            }
            
            // 3. Update output blocks
            document.querySelectorAll('.output-block').forEach(b => {
                const cb = b.querySelector('.output-checkbox');
                b.classList.toggle('inactive', !cb.checked);
            });
            
            // 4. Draw connectors
            // Input -> R1 Models (split)
            drawInputSplitConnector('svg-in-models', 'r1-models', 'active');
            
            if (roundCounter === 1) {
                // Minimal: Models -> Results
                drawHorizontalConnectors('svg-models-results', 'r1-models', 'brain-flow');
            } else {
                // Full template
                // R1 Models -> Responses R1
                drawHorizontalConnectors('svg-r1-resp1', 'r1-models', 'brain-flow');
                
                // Responses R1 -> R2 Judge
                drawMergeSplitConnector('svg-resp1-r2', 'resp1-stack', 'r2-models', 'active');
                
                // Intermediate rounds: Judge -> Responses -> next Judge
                for (let r = 2; r < roundCounter; r++) {
                    drawHorizontalConnectors(`svg-r${r}-resp${r}`, `r${r}-models`, 'brain-flow');
                    drawMergeSplitConnector(`svg-resp${r}-r${r+1}`, `resp${r}-stack`, `r${r+1}-models`, 'active');
                }
                
                // Last Judge -> Results
                drawHorizontalConnectors('svg-judge-results', `r${roundCounter}-models`, 'brain-flow');
            }
            
            // Results -> Output
            drawMergeSplitConnector('svg-results-out', 'results-stack', 'output-stack', 'active');
        }
        
        function resetPipeline() {
            if (confirm('Reset to default?')) {
                location.reload();
            }
        }
        
        function addRound() {
            const insertionPoint = document.getElementById('insertionPoint');
            
            if (roundCounter === 1) {
                // Adding first Judge: Models ‚Üí Responses ‚Üí Judge ‚Üí Results
                roundCounter = 2;
                
                // Change connector id
                const connectorToResults = document.getElementById('connectorToResults');
                const svgModelsResults = document.getElementById('svg-models-results');
                if (svgModelsResults) svgModelsResults.id = 'svg-r1-resp1';
                
                const newRoundHTML = `
                    <!-- Responses R1 -->
                    <div class="collector-column" id="responses1">
                        <div class="stage-label">Responses</div>
                        <div class="collector-stack" id="resp1-stack">
                            <div class="collector-row" data-index="0">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">Claude</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                            <div class="collector-row" data-index="1">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">GPT-4</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                            <div class="collector-row" data-index="2">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">Gemini</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                            <div class="collector-row inactive" data-index="3">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">Llama 3</span>
                                <input type="checkbox" class="collector-checkbox" disabled>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connector Responses -> R2 Judge -->
                    <div class="connector-group">
                        <svg class="connector-svg" id="svg-resp1-r2"></svg>
                    </div>
                    
                    <!-- R2 Judge -->
                    <div class="stage-column" id="round2" data-round="2">
                        <div class="stage-label"><span class="round-badge">R2</span> Judge</div>
                        <div class="model-stack" id="r2-models">
                            <div class="model-block active with-role" data-index="0">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                    <span class="model-name">Claude</span>
                                </div>
                                <select class="role-selector">
                                    <option>Synthesis</option>
                                    <option>Critic</option>
                                    <option>Meta</option>
                                    <option>Advocate</option>
                                </select>
                            </div>
                            <div class="model-block active with-role" data-index="1">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                    <span class="model-name">GPT-4</span>
                                </div>
                                <select class="role-selector">
                                    <option>Critic</option>
                                    <option>Synthesis</option>
                                    <option>Meta</option>
                                    <option>Advocate</option>
                                </select>
                            </div>
                            <div class="model-block inactive with-role" data-index="2">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                    <span class="model-name">Gemini</span>
                                </div>
                                <select class="role-selector" disabled>
                                    <option>Meta</option>
                                    <option>Synthesis</option>
                                    <option>Critic</option>
                                    <option>Advocate</option>
                                </select>
                            </div>
                            <div class="model-block inactive with-role" data-index="3">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                    <span class="model-name">Llama 3</span>
                                </div>
                                <select class="role-selector" disabled>
                                    <option>Advocate</option>
                                    <option>Synthesis</option>
                                    <option>Critic</option>
                                    <option>Meta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                
                // Insert after connector svg-r1-resp1
                const firstConnector = document.getElementById('svg-r1-resp1').parentElement;
                firstConnector.insertAdjacentHTML('afterend', newRoundHTML);
                
                // Update connector to Results
                document.getElementById('svg-judge-results').id = 'svg-judge-results';
                
            } else {
                // Adding more Judges: ... ‚Üí Responses ‚Üí Judge ‚Üí Results
                const currentLastJudge = roundCounter;
                roundCounter++;
                
                const newRoundHTML = `
                    <!-- Connector Judge ${currentLastJudge} -> Responses -->
                    <div class="connector-group" data-round="${roundCounter}">
                        <svg class="connector-svg" id="svg-r${currentLastJudge}-resp${currentLastJudge}"></svg>
                    </div>
                    
                    <!-- Responses ${currentLastJudge} (after Judge ${currentLastJudge}) -->
                    <div class="collector-column" id="responses${currentLastJudge}" data-round="${roundCounter}">
                        <div class="stage-label">Responses</div>
                        <div class="collector-stack" id="resp${currentLastJudge}-stack">
                            <div class="collector-row" data-index="0">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">Claude</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                            <div class="collector-row" data-index="1">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">GPT-4</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                            <div class="collector-row" data-index="2">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">Gemini</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                            <div class="collector-row" data-index="3">
                                <div class="status-indicator"></div>
                                <span class="collector-model-name">Llama 3</span>
                                <input type="checkbox" class="collector-checkbox" checked onchange="updateAll()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connector Responses -> R${roundCounter} Judge -->
                    <div class="connector-group" data-round="${roundCounter}">
                        <svg class="connector-svg" id="svg-resp${currentLastJudge}-r${roundCounter}"></svg>
                    </div>
                    
                    <!-- R${roundCounter} Judge -->
                    <div class="stage-column" id="round${roundCounter}" data-round="${roundCounter}">
                        <div class="stage-label"><span class="round-badge">R${roundCounter}</span> Judge</div>
                        <div class="model-stack" id="r${roundCounter}-models">
                            <div class="model-block active with-role" data-index="0">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" checked onchange="updateAll()">
                                    <span class="model-name">Claude</span>
                                </div>
                                <select class="role-selector">
                                    <option>Synthesis</option>
                                    <option>Critic</option>
                                    <option>Meta</option>
                                    <option>Advocate</option>
                                </select>
                            </div>
                            <div class="model-block inactive with-role" data-index="1">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                    <span class="model-name">GPT-4</span>
                                </div>
                                <select class="role-selector" disabled>
                                    <option>Critic</option>
                                    <option>Synthesis</option>
                                    <option>Meta</option>
                                    <option>Advocate</option>
                                </select>
                            </div>
                            <div class="model-block inactive with-role" data-index="2">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                    <span class="model-name">Gemini</span>
                                </div>
                                <select class="role-selector" disabled>
                                    <option>Meta</option>
                                    <option>Synthesis</option>
                                    <option>Critic</option>
                                    <option>Advocate</option>
                                </select>
                            </div>
                            <div class="model-block inactive with-role" data-index="3">
                                <div class="model-header">
                                    <input type="checkbox" class="model-checkbox" onchange="updateAll()">
                                    <span class="model-name">Llama 3</span>
                                </div>
                                <select class="role-selector" disabled>
                                    <option>Advocate</option>
                                    <option>Synthesis</option>
                                    <option>Critic</option>
                                    <option>Meta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                
                insertionPoint.insertAdjacentHTML('beforebegin', newRoundHTML);
            }
            
            document.getElementById('removeRoundBtn').style.display = 'flex';
            updateAll();
        }
        
        function removeLastRound() {
            if (roundCounter <= 1) return;
            
            if (roundCounter === 2) {
                // Remove R2 Judge and Responses R1, leaving only Models ‚Üí Results
                document.querySelectorAll(`[data-round="2"]`).forEach(el => el.remove());
                
                // Remove Responses R1
                const responses1 = document.getElementById('responses1');
                if (responses1) responses1.remove();
                
                // Remove connectors
                const svgR1Resp = document.getElementById('svg-r1-resp1');
                if (svgR1Resp) svgR1Resp.parentElement.remove();
                
                const svgResp1R2 = document.getElementById('svg-resp1-r2');
                if (svgResp1R2) svgResp1R2.parentElement.remove();
                
                // Change connector to Results
                document.getElementById('svg-judge-results').id = 'svg-models-results';
                
                roundCounter = 1;
                document.getElementById('removeRoundBtn').style.display = 'none';
            } else {
                // Remove last round (Responses + Judge)
                document.querySelectorAll(`[data-round="${roundCounter}"]`).forEach(el => el.remove());
                roundCounter--;
            }
            
            updateAll();
        }
        
        function savePipeline() {
            const name = prompt('Pipeline name:', document.getElementById('currentPipelineName').textContent);
            if (name && name.trim()) {
                addPipelineToList(name.trim());
            }
        }
        
        function addNewPipeline() {
            const name = prompt('New pipeline name:');
            if (name && name.trim()) {
                // Reset to minimal template: Models ‚Üí Results ‚Üí Output
                resetToMinimalTemplate();
                addPipelineToList(name.trim());
                document.getElementById('currentPipelineName').textContent = name.trim();
            }
        }
        
        function resetToMinimalTemplate() {
            // Remove all rounds > 1 (keep only R1 Models)
            for (let r = roundCounter; r >= 2; r--) {
                document.querySelectorAll(`[data-round="${r}"]`).forEach(el => el.remove());
            }
            
            // Remove Responses R1
            const responses1 = document.getElementById('responses1');
            if (responses1) responses1.remove();
            
            // Remove connector R1 -> Responses
            const svgR1Resp = document.getElementById('svg-r1-resp1');
            if (svgR1Resp) svgR1Resp.parentElement.remove();
            
            // Remove connector Responses -> R2
            const svgResp1R2 = document.getElementById('svg-resp1-r2');
            if (svgResp1R2) svgResp1R2.parentElement.remove();
            
            // Update connector before Results to come from Models
            document.getElementById('svg-judge-results').id = 'svg-models-results';
            
            roundCounter = 1; // Only R1 Models, no Judge
            
            // Hide remove button
            document.getElementById('removeRoundBtn').style.display = 'none';
            
            updateAll();
        }
        
        function addPipelineToList(name) {
            const items = document.getElementById('pipelineItems');
            
            const existing = items.querySelector(`[data-name="${name}"]`);
            if (existing) {
                selectPipeline(existing);
                return;
            }
            
            items.querySelectorAll('.last-badge').forEach(b => b.remove());
            items.querySelectorAll('.pipeline-item').forEach(i => i.classList.remove('active'));
            items.querySelectorAll('.pipeline-radio').forEach(r => r.checked = false);
            
            const newItem = document.createElement('div');
            newItem.className = 'pipeline-item active';
            newItem.dataset.name = name;
            newItem.innerHTML = `
                <input type="radio" name="pipeline" class="pipeline-radio" checked>
                <span class="pipeline-item-name">${name}</span>
                <span class="last-badge">last</span>
            `;
            newItem.addEventListener('click', function() { selectPipeline(this); });
            items.appendChild(newItem);
            
            document.getElementById('currentPipelineName').textContent = name;
        }
        
        function selectPipeline(item) {
            document.querySelectorAll('.pipeline-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.pipeline-radio').forEach(r => r.checked = false);
            
            item.classList.add('active');
            item.querySelector('.pipeline-radio').checked = true;
            document.getElementById('currentPipelineName').textContent = item.dataset.name;
        }
        
        document.querySelectorAll('.pipeline-item').forEach(item => {
            item.addEventListener('click', function() { selectPipeline(this); });
        });
        
        // Init
        updateAll();
    </script>
</body>
</html>
